function D(e){window.enmity.plugins.registerPlugin(e)}function k(e){return window.enmity.patcher.create(e)}function u(e,n,s,l){window.enmity.clyde.sendReply(e,n,s,l)}function y(e,n,s){return window.enmity.settings.get(e,n,s)}var $="MessageSniffer",C="1.0.3",A="Logs all message events including edits, deletions, and bulk deletions",_=[{name:"abcwrlds",id:"0"}],w={name:$,version:C,description:A,authors:_};const U=k("message-logger");function M(...e){return window.enmity.modules.getByProps(...e)}const h=[],i={deleted:[],edited:[],bulkDeleted:[],maxEntries:1e3};function m(e,n){return y(w.name,e,n)}function b(e){return new Date(e).toLocaleString()}function v(e,n=100){return e?e.length<=n?e:e.substring(0,n)+"...":"[No content]"}const f=new Map;M("getMessage","getMessages");const E=M("getUser","getCurrentUser"),S=M("getChannel","getDMFromUserId");function L(e,n){var s,l,o,r;const t=f.get(n);if(!t)return;const d=S==null?void 0:S.getChannel(e),a=E==null?void 0:E.getUser((s=t.author)==null?void 0:s.id),g={type:"deleted",messageId:n,channelId:e,channelName:(d==null?void 0:d.name)||"Unknown Channel",guildId:d==null?void 0:d.guild_id,content:t.content,author:{id:(l=t.author)==null?void 0:l.id,username:(a==null?void 0:a.username)||((o=t.author)==null?void 0:o.username)||"Unknown",discriminator:(a==null?void 0:a.discriminator)||((r=t.author)==null?void 0:r.discriminator)||"0000"},timestamp:t.timestamp,deletedAt:Date.now(),attachments:t.attachments||[],embeds:t.embeds||[]};i.deleted.unshift(g),i.deleted.length>m("maxLogSize",1e3)&&i.deleted.pop(),m("showNotifications",!0)&&console.log(`[MessageSniffer] Deleted message from ${g.author.username}: ${v(g.content)}`)}function N(e,n,s){var l,o,r,t;const d=f.get(n);if(!d||d.content===s.content)return;const a=S==null?void 0:S.getChannel(e),g=E==null?void 0:E.getUser((l=s.author)==null?void 0:l.id),c={type:"edited",messageId:n,channelId:e,channelName:(a==null?void 0:a.name)||"Unknown Channel",guildId:a==null?void 0:a.guild_id,oldContent:d.content,newContent:s.content,author:{id:(o=s.author)==null?void 0:o.id,username:(g==null?void 0:g.username)||((r=s.author)==null?void 0:r.username)||"Unknown",discriminator:(g==null?void 0:g.discriminator)||((t=s.author)==null?void 0:t.discriminator)||"0000"},originalTimestamp:d.timestamp,editedAt:Date.now()};i.edited.unshift(c),i.edited.length>m("maxLogSize",1e3)&&i.edited.pop(),m("showNotifications",!0)&&console.log(`[MessageSniffer] Edited message from ${c.author.username}`),f.set(n,{...s})}function I(e,n){const s=S==null?void 0:S.getChannel(e),l=[];n.forEach(r=>{var t,d,a,g;const c=f.get(r);if(c){const p=E==null?void 0:E.getUser((t=c.author)==null?void 0:t.id);l.push({messageId:r,content:c.content,author:{id:(d=c.author)==null?void 0:d.id,username:(p==null?void 0:p.username)||((a=c.author)==null?void 0:a.username)||"Unknown",discriminator:(p==null?void 0:p.discriminator)||((g=c.author)==null?void 0:g.discriminator)||"0000"},timestamp:c.timestamp})}});const o={type:"bulk_deleted",channelId:e,channelName:(s==null?void 0:s.name)||"Unknown Channel",guildId:s==null?void 0:s.guild_id,messageCount:n.length,messages:l,deletedAt:Date.now()};i.bulkDeleted.unshift(o),i.bulkDeleted.length>m("maxLogSize",1e3)&&i.bulkDeleted.pop(),m("showNotifications",!0)&&console.log(`[MessageSniffer] Bulk deleted ${n.length} messages in ${o.channelName}`)}function T(e){var n;switch((n=e[0])==null?void 0:n.toLowerCase()){case"deleted":if(i.deleted.length===0){u("No deleted messages logged.");return}let s=`**Deleted Messages (${i.deleted.length}):**

`;i.deleted.slice(0,10).forEach((t,d)=>{s+=`**${d+1}.** ${t.author.username}#${t.author.discriminator} in #${t.channelName}
`,s+=`   Content: ${v(t.content,150)}
`,s+=`   Deleted: ${b(t.deletedAt)}

`}),u(s);break;case"edited":if(i.edited.length===0){u("No edited messages logged.");return}let l=`**Edited Messages (${i.edited.length}):**

`;i.edited.slice(0,10).forEach((t,d)=>{l+=`**${d+1}.** ${t.author.username}#${t.author.discriminator} in #${t.channelName}
`,l+=`   Old: ${v(t.oldContent,100)}
`,l+=`   New: ${v(t.newContent,100)}
`,l+=`   Edited: ${b(t.editedAt)}

`}),u(l);break;case"bulk":if(i.bulkDeleted.length===0){u("No bulk deletions logged.");return}let o=`**Bulk Deletions (${i.bulkDeleted.length}):**

`;i.bulkDeleted.slice(0,5).forEach((t,d)=>{o+=`**${d+1}.** ${t.messageCount} messages in #${t.channelName}
`,o+=`   Deleted: ${b(t.deletedAt)}

`}),u(o);break;case"clear":i.deleted=[],i.edited=[],i.bulkDeleted=[],f.clear(),u("Message logs cleared.");break;case"stats":const r=`**Message Logger Statistics:**

Deleted Messages: ${i.deleted.length}
Edited Messages: ${i.edited.length}
Bulk Deletions: ${i.bulkDeleted.length}
Cached Messages: ${f.size}`;u(r);break;default:u(`**Message Logger Commands:**

/msglog deleted - View recently deleted messages
/msglog edited - View recently edited messages
/msglog bulk - View bulk deletion events
/msglog stats - View logging statistics
/msglog clear - Clear all logs`)}}const G={...w,onStart(){console.log("[MessageSniffer] Plugin started");try{const{Dispatcher:e}=window.enmity.modules.common;if(console.log("[MessageSniffer] Dispatcher:",!!e),e){const s=l=>{try{l.message&&l.message.id&&f.set(l.message.id,{...l.message})}catch(o){console.error("[MessageSniffer] Error in MESSAGE_CREATE:",o)}};if(e.subscribe("MESSAGE_CREATE",s),h.push({type:"MESSAGE_CREATE",handler:s}),m("logDeleted",!0)){const l=o=>{try{o.channelId&&o.id&&L(o.channelId,o.id)}catch(r){console.error("[MessageSniffer] Error in MESSAGE_DELETE:",r)}};e.subscribe("MESSAGE_DELETE",l),h.push({type:"MESSAGE_DELETE",handler:l})}if(m("logEdited",!0)){const l=o=>{try{o.message&&o.message.id&&o.message.edited_timestamp&&N(o.message.channel_id,o.message.id,o.message)}catch(r){console.error("[MessageSniffer] Error in MESSAGE_UPDATE:",r)}};e.subscribe("MESSAGE_UPDATE",l),h.push({type:"MESSAGE_UPDATE",handler:l})}if(m("logBulkDeleted",!0)){const l=o=>{try{o.channelId&&o.ids&&I(o.channelId,o.ids)}catch(r){console.error("[MessageSniffer] Error in MESSAGE_DELETE_BULK:",r)}};e.subscribe("MESSAGE_DELETE_BULK",l),h.push({type:"MESSAGE_DELETE_BULK",handler:l})}console.log("[MessageSniffer] Subscribed to",h.length,"events")}const n=M("registerCommand");console.log("[MessageSniffer] Commands module:",!!n),n&&n.registerCommand&&(n.registerCommand({name:"msglog",description:"Message logger commands",execute:s=>T(s)}),console.log("[MessageSniffer] Command registered"))}catch(e){console.error("[MessageSniffer] Error during plugin start:",e)}},onStop(){console.log("[MessageSniffer] Plugin stopped");try{U.unpatchAll();const{Dispatcher:e}=window.enmity.modules.common;e&&e.unsubscribe&&h.forEach(n=>{try{e.unsubscribe(n.type,n.handler),console.log("[MessageSniffer] Unsubscribed from",n.type)}catch(s){console.error(`[MessageSniffer] Error unsubscribing from ${n.type}:`,s)}}),h.length=0,console.log("[MessageSniffer] Cleanup complete")}catch(e){console.error("[MessageSniffer] Error during plugin stop:",e)}}};D(G);
