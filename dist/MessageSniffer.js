function k(n){window.enmity.plugins.registerPlugin(n)}function D(n){return window.enmity.patcher.create(n)}function c(n,t,i,d){window.enmity.clyde.sendReply(n,t,i,d)}var w="MessageSniffer",$="1.0.3",y="Logs all message events including edits, deletions, and bulk deletions",A=[{name:"abcwrlds",id:"0"}],C={name:w,version:$,description:y,authors:A};const _=D("message-logger");function m(...n){return window.enmity.modules.getByProps(...n)}const E=[],o={deleted:[],edited:[],bulkDeleted:[],maxEntries:1e3};let f={logDeleted:!0,logEdited:!0,logBulkDeleted:!0,showNotifications:!0,maxLogSize:1e3};function M(n){return new Date(n).toLocaleString()}function b(n,t=100){return n?n.length<=t?n:n.substring(0,t)+"...":"[No content]"}const h=new Map;m("getMessage","getMessages");const p=m("getUser","getCurrentUser"),S=m("getChannel","getDMFromUserId");function L(n,t){var i,d,l,s;const e=h.get(t);if(!e)return;const a=S==null?void 0:S.getChannel(n),r=p==null?void 0:p.getUser((i=e.author)==null?void 0:i.id),g={type:"deleted",messageId:t,channelId:n,channelName:(a==null?void 0:a.name)||"Unknown Channel",guildId:a==null?void 0:a.guild_id,content:e.content,author:{id:(d=e.author)==null?void 0:d.id,username:(r==null?void 0:r.username)||((l=e.author)==null?void 0:l.username)||"Unknown",discriminator:(r==null?void 0:r.discriminator)||((s=e.author)==null?void 0:s.discriminator)||"0000"},timestamp:e.timestamp,deletedAt:Date.now(),attachments:e.attachments||[],embeds:e.embeds||[]};o.deleted.unshift(g),o.deleted.length>f.maxLogSize&&o.deleted.pop(),console.log(`[MessageSniffer] Deleted message from ${g.author.username}: ${b(g.content)}`)}function U(n,t,i){var d,l,s,e;const a=h.get(t);if(!a||a.content===i.content)return;const r=S==null?void 0:S.getChannel(n),g=p==null?void 0:p.getUser((d=i.author)==null?void 0:d.id),u={type:"edited",messageId:t,channelId:n,channelName:(r==null?void 0:r.name)||"Unknown Channel",guildId:r==null?void 0:r.guild_id,oldContent:a.content,newContent:i.content,author:{id:(l=i.author)==null?void 0:l.id,username:(g==null?void 0:g.username)||((s=i.author)==null?void 0:s.username)||"Unknown",discriminator:(g==null?void 0:g.discriminator)||((e=i.author)==null?void 0:e.discriminator)||"0000"},originalTimestamp:a.timestamp,editedAt:Date.now()};o.edited.unshift(u),o.edited.length>f.maxLogSize&&o.edited.pop(),console.log(`[MessageSniffer] Edited message from ${u.author.username}`),h.set(t,{...i})}function I(n,t){const i=S==null?void 0:S.getChannel(n),d=[];t.forEach(s=>{var e,a,r,g;const u=h.get(s);if(u){const v=p==null?void 0:p.getUser((e=u.author)==null?void 0:e.id);d.push({messageId:s,content:u.content,author:{id:(a=u.author)==null?void 0:a.id,username:(v==null?void 0:v.username)||((r=u.author)==null?void 0:r.username)||"Unknown",discriminator:(v==null?void 0:v.discriminator)||((g=u.author)==null?void 0:g.discriminator)||"0000"},timestamp:u.timestamp})}});const l={type:"bulk_deleted",channelId:n,channelName:(i==null?void 0:i.name)||"Unknown Channel",guildId:i==null?void 0:i.guild_id,messageCount:t.length,messages:d,deletedAt:Date.now()};o.bulkDeleted.unshift(l),o.bulkDeleted.length>f.maxLogSize&&o.bulkDeleted.pop(),console.log(`[MessageSniffer] Bulk deleted ${t.length} messages in ${l.channelName}`)}function N(n){var t;switch((t=n[0])==null?void 0:t.toLowerCase()){case"deleted":if(o.deleted.length===0){c("No deleted messages logged.");return}let i=`**Deleted Messages (${o.deleted.length}):**

`;o.deleted.slice(0,10).forEach((e,a)=>{i+=`**${a+1}.** ${e.author.username}#${e.author.discriminator} in #${e.channelName}
`,i+=`   Content: ${b(e.content,150)}
`,i+=`   Deleted: ${M(e.deletedAt)}

`}),c(i);break;case"edited":if(o.edited.length===0){c("No edited messages logged.");return}let d=`**Edited Messages (${o.edited.length}):**

`;o.edited.slice(0,10).forEach((e,a)=>{d+=`**${a+1}.** ${e.author.username}#${e.author.discriminator} in #${e.channelName}
`,d+=`   Old: ${b(e.oldContent,100)}
`,d+=`   New: ${b(e.newContent,100)}
`,d+=`   Edited: ${M(e.editedAt)}

`}),c(d);break;case"bulk":if(o.bulkDeleted.length===0){c("No bulk deletions logged.");return}let l=`**Bulk Deletions (${o.bulkDeleted.length}):**

`;o.bulkDeleted.slice(0,5).forEach((e,a)=>{l+=`**${a+1}.** ${e.messageCount} messages in #${e.channelName}
`,l+=`   Deleted: ${M(e.deletedAt)}

`}),c(l);break;case"clear":o.deleted=[],o.edited=[],o.bulkDeleted=[],h.clear(),c("Message logs cleared.");break;case"stats":const s=`**Message Logger Statistics:**

Deleted Messages: ${o.deleted.length}
Edited Messages: ${o.edited.length}
Bulk Deletions: ${o.bulkDeleted.length}
Cached Messages: ${h.size}`;c(s);break;default:c(`**Message Logger Commands:**

/msglog deleted - View recently deleted messages
/msglog edited - View recently edited messages
/msglog bulk - View bulk deletion events
/msglog stats - View logging statistics
/msglog clear - Clear all logs`)}}const T={...C,onStart(){var n;console.log("[MessageSniffer] Plugin started"),console.log("[MessageSniffer] Enmity version:",(n=window.enmity)==null?void 0:n.version);try{const t=m("_dispatch","_subscriptions")||m("dispatch","subscribe");if(console.log("[MessageSniffer] Dispatcher found:",!!t),t&&t.subscribe){const d=t.subscribe("MESSAGE_CREATE",l=>{try{l.message&&l.message.id&&h.set(l.message.id,{...l.message})}catch(s){console.error("[MessageSniffer] Error in MESSAGE_CREATE:",s)}});if(E.push({type:"MESSAGE_CREATE",token:d}),f.logDeleted){const l=t.subscribe("MESSAGE_DELETE",s=>{try{s.channelId&&s.id&&L(s.channelId,s.id)}catch(e){console.error("[MessageSniffer] Error in MESSAGE_DELETE:",e)}});E.push({type:"MESSAGE_DELETE",token:l})}if(f.logEdited){const l=t.subscribe("MESSAGE_UPDATE",s=>{try{s.message&&s.message.id&&s.message.edited_timestamp&&U(s.message.channel_id,s.message.id,s.message)}catch(e){console.error("[MessageSniffer] Error in MESSAGE_UPDATE:",e)}});E.push({type:"MESSAGE_UPDATE",token:l})}if(f.logBulkDeleted){const l=t.subscribe("MESSAGE_DELETE_BULK",s=>{try{s.channelId&&s.ids&&I(s.channelId,s.ids)}catch(e){console.error("[MessageSniffer] Error in MESSAGE_DELETE_BULK:",e)}});E.push({type:"MESSAGE_DELETE_BULK",token:l})}}const i=m("registerCommand");i&&i.registerCommand&&i.registerCommand({name:"msglog",description:"Message logger commands",execute:d=>N(d)})}catch(t){console.error("[MessageSniffer] Error during plugin start:",t)}},onStop(){console.log("[MessageSniffer] Plugin stopped");try{_.unpatchAll();const n=m("_dispatch","_subscriptions")||m("dispatch","subscribe");n&&n.unsubscribe&&E.forEach(t=>{try{n.unsubscribe(t.type,t.token)}catch(i){console.error(`[MessageSniffer] Error unsubscribing from ${t.type}:`,i)}}),E.length=0}catch(n){console.error("[MessageSniffer] Error during plugin stop:",n)}}};k(T);
