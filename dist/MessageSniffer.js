function D(e){window.enmity.plugins.registerPlugin(e)}function w(e){return window.enmity.patcher.create(e)}function u(e,o,l,t){window.enmity.clyde.sendReply(e,o,l,t)}var k="MessageSniffer",y="1.0.3",C="Logs all message events including edits, deletions, and bulk deletions",$=[{name:"abcwrlds",id:"0"}],A={name:k,version:y,description:C,authors:$};const _=w("message-logger");function M(...e){return window.enmity.modules.getByProps(...e)}const m=[],i={deleted:[],edited:[],bulkDeleted:[],maxEntries:1e3};let f={logDeleted:!0,logEdited:!0,logBulkDeleted:!0,showNotifications:!0,maxLogSize:1e3};function b(e){return new Date(e).toLocaleString()}function v(e,o=100){return e?e.length<=o?e:e.substring(0,o)+"...":"[No content]"}const h=new Map;M("getMessage","getMessages");const E=M("getUser","getCurrentUser"),S=M("getChannel","getDMFromUserId");function L(e,o){var l,t,s,a;const n=h.get(o);if(!n)return;const d=S==null?void 0:S.getChannel(e),r=E==null?void 0:E.getUser((l=n.author)==null?void 0:l.id),g={type:"deleted",messageId:o,channelId:e,channelName:(d==null?void 0:d.name)||"Unknown Channel",guildId:d==null?void 0:d.guild_id,content:n.content,author:{id:(t=n.author)==null?void 0:t.id,username:(r==null?void 0:r.username)||((s=n.author)==null?void 0:s.username)||"Unknown",discriminator:(r==null?void 0:r.discriminator)||((a=n.author)==null?void 0:a.discriminator)||"0000"},timestamp:n.timestamp,deletedAt:Date.now(),attachments:n.attachments||[],embeds:n.embeds||[]};i.deleted.unshift(g),i.deleted.length>f.maxLogSize&&i.deleted.pop(),console.log(`[MessageSniffer] Deleted message from ${g.author.username}: ${v(g.content)}`)}function U(e,o,l){var t,s,a,n;const d=h.get(o);if(!d||d.content===l.content)return;const r=S==null?void 0:S.getChannel(e),g=E==null?void 0:E.getUser((t=l.author)==null?void 0:t.id),c={type:"edited",messageId:o,channelId:e,channelName:(r==null?void 0:r.name)||"Unknown Channel",guildId:r==null?void 0:r.guild_id,oldContent:d.content,newContent:l.content,author:{id:(s=l.author)==null?void 0:s.id,username:(g==null?void 0:g.username)||((a=l.author)==null?void 0:a.username)||"Unknown",discriminator:(g==null?void 0:g.discriminator)||((n=l.author)==null?void 0:n.discriminator)||"0000"},originalTimestamp:d.timestamp,editedAt:Date.now()};i.edited.unshift(c),i.edited.length>f.maxLogSize&&i.edited.pop(),console.log(`[MessageSniffer] Edited message from ${c.author.username}`),h.set(o,{...l})}function I(e,o){const l=S==null?void 0:S.getChannel(e),t=[];o.forEach(a=>{var n,d,r,g;const c=h.get(a);if(c){const p=E==null?void 0:E.getUser((n=c.author)==null?void 0:n.id);t.push({messageId:a,content:c.content,author:{id:(d=c.author)==null?void 0:d.id,username:(p==null?void 0:p.username)||((r=c.author)==null?void 0:r.username)||"Unknown",discriminator:(p==null?void 0:p.discriminator)||((g=c.author)==null?void 0:g.discriminator)||"0000"},timestamp:c.timestamp})}});const s={type:"bulk_deleted",channelId:e,channelName:(l==null?void 0:l.name)||"Unknown Channel",guildId:l==null?void 0:l.guild_id,messageCount:o.length,messages:t,deletedAt:Date.now()};i.bulkDeleted.unshift(s),i.bulkDeleted.length>f.maxLogSize&&i.bulkDeleted.pop(),console.log(`[MessageSniffer] Bulk deleted ${o.length} messages in ${s.channelName}`)}function N(e){var o;switch((o=e[0])==null?void 0:o.toLowerCase()){case"deleted":if(i.deleted.length===0){u("No deleted messages logged.");return}let l=`**Deleted Messages (${i.deleted.length}):**

`;i.deleted.slice(0,10).forEach((n,d)=>{l+=`**${d+1}.** ${n.author.username}#${n.author.discriminator} in #${n.channelName}
`,l+=`   Content: ${v(n.content,150)}
`,l+=`   Deleted: ${b(n.deletedAt)}

`}),u(l);break;case"edited":if(i.edited.length===0){u("No edited messages logged.");return}let t=`**Edited Messages (${i.edited.length}):**

`;i.edited.slice(0,10).forEach((n,d)=>{t+=`**${d+1}.** ${n.author.username}#${n.author.discriminator} in #${n.channelName}
`,t+=`   Old: ${v(n.oldContent,100)}
`,t+=`   New: ${v(n.newContent,100)}
`,t+=`   Edited: ${b(n.editedAt)}

`}),u(t);break;case"bulk":if(i.bulkDeleted.length===0){u("No bulk deletions logged.");return}let s=`**Bulk Deletions (${i.bulkDeleted.length}):**

`;i.bulkDeleted.slice(0,5).forEach((n,d)=>{s+=`**${d+1}.** ${n.messageCount} messages in #${n.channelName}
`,s+=`   Deleted: ${b(n.deletedAt)}

`}),u(s);break;case"clear":i.deleted=[],i.edited=[],i.bulkDeleted=[],h.clear(),u("Message logs cleared.");break;case"stats":const a=`**Message Logger Statistics:**

Deleted Messages: ${i.deleted.length}
Edited Messages: ${i.edited.length}
Bulk Deletions: ${i.bulkDeleted.length}
Cached Messages: ${h.size}`;u(a);break;default:u(`**Message Logger Commands:**

/msglog deleted - View recently deleted messages
/msglog edited - View recently edited messages
/msglog bulk - View bulk deletion events
/msglog stats - View logging statistics
/msglog clear - Clear all logs`)}}const T={...A,onStart(){console.log("[MessageSniffer] Plugin started");try{const{Dispatcher:e}=window.enmity.modules.common;if(console.log("[MessageSniffer] Dispatcher:",!!e),e){const l=t=>{try{t.message&&t.message.id&&(h.set(t.message.id,{...t.message}),console.log("[MessageSniffer] Cached message:",t.message.id))}catch(s){console.error("[MessageSniffer] Error in MESSAGE_CREATE:",s)}};if(e.subscribe("MESSAGE_CREATE",l),m.push({type:"MESSAGE_CREATE",handler:l}),f.logDeleted){const t=s=>{try{s.channelId&&s.id&&L(s.channelId,s.id)}catch(a){console.error("[MessageSniffer] Error in MESSAGE_DELETE:",a)}};e.subscribe("MESSAGE_DELETE",t),m.push({type:"MESSAGE_DELETE",handler:t})}if(f.logEdited){const t=s=>{try{s.message&&s.message.id&&s.message.edited_timestamp&&U(s.message.channel_id,s.message.id,s.message)}catch(a){console.error("[MessageSniffer] Error in MESSAGE_UPDATE:",a)}};e.subscribe("MESSAGE_UPDATE",t),m.push({type:"MESSAGE_UPDATE",handler:t})}if(f.logBulkDeleted){const t=s=>{try{s.channelId&&s.ids&&I(s.channelId,s.ids)}catch(a){console.error("[MessageSniffer] Error in MESSAGE_DELETE_BULK:",a)}};e.subscribe("MESSAGE_DELETE_BULK",t),m.push({type:"MESSAGE_DELETE_BULK",handler:t})}console.log("[MessageSniffer] Subscribed to",m.length,"events")}const o=M("registerCommand");console.log("[MessageSniffer] Commands module:",!!o),o&&o.registerCommand&&(o.registerCommand({name:"msglog",description:"Message logger commands",execute:l=>N(l)}),console.log("[MessageSniffer] Command registered"))}catch(e){console.error("[MessageSniffer] Error during plugin start:",e)}},onStop(){console.log("[MessageSniffer] Plugin stopped");try{_.unpatchAll();const{Dispatcher:e}=window.enmity.modules.common;e&&e.unsubscribe&&m.forEach(o=>{try{e.unsubscribe(o.type,o.handler),console.log("[MessageSniffer] Unsubscribed from",o.type)}catch(l){console.error(`[MessageSniffer] Error unsubscribing from ${o.type}:`,l)}}),m.length=0,console.log("[MessageSniffer] Cleanup complete")}catch(e){console.error("[MessageSniffer] Error during plugin stop:",e)}}};D(T);
