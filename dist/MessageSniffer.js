function k(e){window.enmity.plugins.registerPlugin(e)}function m(...e){return window.enmity.modules.getByProps(...e)}window.enmity.modules.common;function D(e){return window.enmity.patcher.create(e)}function c(e,l,s,o){window.enmity.clyde.sendReply(e,l,s,o)}var w="MessageSniffer",$="1.0.3",y="Logs all message events including edits, deletions, and bulk deletions",A=[{name:"abcwrlds",id:"0"}],C={name:w,version:$,description:y,authors:A};const _=D("message-logger"),E=[],i={deleted:[],edited:[],bulkDeleted:[],maxEntries:1e3};let f={logDeleted:!0,logEdited:!0,logBulkDeleted:!0,showNotifications:!0,maxLogSize:1e3};function M(e){return new Date(e).toLocaleString()}function v(e,l=100){return e?e.length<=l?e:e.substring(0,l)+"...":"[No content]"}const h=new Map;m("getMessage","getMessages");const p=m("getUser","getCurrentUser"),b=m("getChannel","getDMFromUserId");function L(e,l){var s,o,t,a;const n=h.get(l);if(!n)return;const d=b==null?void 0:b.getChannel(e),r=p==null?void 0:p.getUser((s=n.author)==null?void 0:s.id),g={type:"deleted",messageId:l,channelId:e,channelName:(d==null?void 0:d.name)||"Unknown Channel",guildId:d==null?void 0:d.guild_id,content:n.content,author:{id:(o=n.author)==null?void 0:o.id,username:(r==null?void 0:r.username)||((t=n.author)==null?void 0:t.username)||"Unknown",discriminator:(r==null?void 0:r.discriminator)||((a=n.author)==null?void 0:a.discriminator)||"0000"},timestamp:n.timestamp,deletedAt:Date.now(),attachments:n.attachments||[],embeds:n.embeds||[]};i.deleted.unshift(g),i.deleted.length>f.maxLogSize&&i.deleted.pop(),console.log(`[MessageSniffer] Deleted message from ${g.author.username}: ${v(g.content)}`)}function U(e,l,s){var o,t,a,n;const d=h.get(l);if(!d||d.content===s.content)return;const r=b==null?void 0:b.getChannel(e),g=p==null?void 0:p.getUser((o=s.author)==null?void 0:o.id),u={type:"edited",messageId:l,channelId:e,channelName:(r==null?void 0:r.name)||"Unknown Channel",guildId:r==null?void 0:r.guild_id,oldContent:d.content,newContent:s.content,author:{id:(t=s.author)==null?void 0:t.id,username:(g==null?void 0:g.username)||((a=s.author)==null?void 0:a.username)||"Unknown",discriminator:(g==null?void 0:g.discriminator)||((n=s.author)==null?void 0:n.discriminator)||"0000"},originalTimestamp:d.timestamp,editedAt:Date.now()};i.edited.unshift(u),i.edited.length>f.maxLogSize&&i.edited.pop(),console.log(`[MessageSniffer] Edited message from ${u.author.username}`),h.set(l,{...s})}function I(e,l){const s=b==null?void 0:b.getChannel(e),o=[];l.forEach(a=>{var n,d,r,g;const u=h.get(a);if(u){const S=p==null?void 0:p.getUser((n=u.author)==null?void 0:n.id);o.push({messageId:a,content:u.content,author:{id:(d=u.author)==null?void 0:d.id,username:(S==null?void 0:S.username)||((r=u.author)==null?void 0:r.username)||"Unknown",discriminator:(S==null?void 0:S.discriminator)||((g=u.author)==null?void 0:g.discriminator)||"0000"},timestamp:u.timestamp})}});const t={type:"bulk_deleted",channelId:e,channelName:(s==null?void 0:s.name)||"Unknown Channel",guildId:s==null?void 0:s.guild_id,messageCount:l.length,messages:o,deletedAt:Date.now()};i.bulkDeleted.unshift(t),i.bulkDeleted.length>f.maxLogSize&&i.bulkDeleted.pop(),console.log(`[MessageSniffer] Bulk deleted ${l.length} messages in ${t.channelName}`)}function N(e){var l;switch((l=e[0])==null?void 0:l.toLowerCase()){case"deleted":if(i.deleted.length===0){c("No deleted messages logged.");return}let s=`**Deleted Messages (${i.deleted.length}):**

`;i.deleted.slice(0,10).forEach((n,d)=>{s+=`**${d+1}.** ${n.author.username}#${n.author.discriminator} in #${n.channelName}
`,s+=`   Content: ${v(n.content,150)}
`,s+=`   Deleted: ${M(n.deletedAt)}

`}),c(s);break;case"edited":if(i.edited.length===0){c("No edited messages logged.");return}let o=`**Edited Messages (${i.edited.length}):**

`;i.edited.slice(0,10).forEach((n,d)=>{o+=`**${d+1}.** ${n.author.username}#${n.author.discriminator} in #${n.channelName}
`,o+=`   Old: ${v(n.oldContent,100)}
`,o+=`   New: ${v(n.newContent,100)}
`,o+=`   Edited: ${M(n.editedAt)}

`}),c(o);break;case"bulk":if(i.bulkDeleted.length===0){c("No bulk deletions logged.");return}let t=`**Bulk Deletions (${i.bulkDeleted.length}):**

`;i.bulkDeleted.slice(0,5).forEach((n,d)=>{t+=`**${d+1}.** ${n.messageCount} messages in #${n.channelName}
`,t+=`   Deleted: ${M(n.deletedAt)}

`}),c(t);break;case"clear":i.deleted=[],i.edited=[],i.bulkDeleted=[],h.clear(),c("Message logs cleared.");break;case"stats":const a=`**Message Logger Statistics:**

Deleted Messages: ${i.deleted.length}
Edited Messages: ${i.edited.length}
Bulk Deletions: ${i.bulkDeleted.length}
Cached Messages: ${h.size}`;c(a);break;default:c(`**Message Logger Commands:**

/msglog deleted - View recently deleted messages
/msglog edited - View recently edited messages
/msglog bulk - View bulk deletion events
/msglog stats - View logging statistics
/msglog clear - Clear all logs`)}}const T={...C,onStart(){console.log("[MessageSniffer] Plugin started");try{const e=m("_dispatch","_subscriptions")||m("dispatch","subscribe");if(e&&e.subscribe){const s=e.subscribe("MESSAGE_CREATE",o=>{try{o.message&&o.message.id&&h.set(o.message.id,{...o.message})}catch(t){console.error("[MessageSniffer] Error in MESSAGE_CREATE:",t)}});if(E.push({type:"MESSAGE_CREATE",token:s}),f.logDeleted){const o=e.subscribe("MESSAGE_DELETE",t=>{try{t.channelId&&t.id&&L(t.channelId,t.id)}catch(a){console.error("[MessageSniffer] Error in MESSAGE_DELETE:",a)}});E.push({type:"MESSAGE_DELETE",token:o})}if(f.logEdited){const o=e.subscribe("MESSAGE_UPDATE",t=>{try{t.message&&t.message.id&&t.message.edited_timestamp&&U(t.message.channel_id,t.message.id,t.message)}catch(a){console.error("[MessageSniffer] Error in MESSAGE_UPDATE:",a)}});E.push({type:"MESSAGE_UPDATE",token:o})}if(f.logBulkDeleted){const o=e.subscribe("MESSAGE_DELETE_BULK",t=>{try{t.channelId&&t.ids&&I(t.channelId,t.ids)}catch(a){console.error("[MessageSniffer] Error in MESSAGE_DELETE_BULK:",a)}});E.push({type:"MESSAGE_DELETE_BULK",token:o})}}const l=m("registerCommand");l&&l.registerCommand&&l.registerCommand({name:"msglog",description:"Message logger commands",execute:s=>N(s)})}catch(e){console.error("[MessageSniffer] Error during plugin start:",e)}},onStop(){console.log("[MessageSniffer] Plugin stopped");try{_.unpatchAll();const e=m("_dispatch","_subscriptions")||m("dispatch","subscribe");e&&e.unsubscribe&&E.forEach(l=>{try{e.unsubscribe(l.type,l.token)}catch(s){console.error(`[MessageSniffer] Error unsubscribing from ${l.type}:`,s)}}),E.length=0}catch(e){console.error("[MessageSniffer] Error during plugin stop:",e)}}};k(T);
